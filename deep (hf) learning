import os
import json
import matplotlib.pyplot as plt
from google.colab import drive

# 1. Drive BaÄŸla
if not os.path.exists('/content/drive'):
    drive.mount('/content/drive')

#  DEEP MODELÄ°NÄ°N YOLU (Senin projedeki yol)
BASE_DIR = "/content/drive/MyDrive/CodeGen_Project/models/deep_instruction/checkpoints"

print(f" KlasÃ¶r taranÄ±yor: {BASE_DIR}")

# 2. En son checkpoint'i bul (En Ã§ok bilgi oradadÄ±r)
try:
    checkpoints = [d for d in os.listdir(BASE_DIR) if "checkpoint" in d]
    # Numaraya gÃ¶re sÄ±rala (en bÃ¼yÃ¼k numara en sondur)
    checkpoints.sort(key=lambda x: int(x.split('-')[-1]))

    latest_checkpoint = checkpoints[-1]
    json_path = os.path.join(BASE_DIR, latest_checkpoint, "trainer_state.json")

    print(f" Bulunan En Son KayÄ±t: {latest_checkpoint}")
    print(f" Okunan Dosya: {json_path}")

except Exception as e:
    print(" HATA: Checkpoint klasÃ¶rÃ¼ bulunamadÄ± veya boÅŸ.")
    print(f"Yol: {BASE_DIR}")
    raise SystemExit("Dosya yok.")

# 3. JSON DosyasÄ±nÄ± Oku ve Verileri Ã‡ek
with open(json_path, 'r') as f:
    data = json.load(f)

log_history = data['log_history']

train_steps = []
train_losses = []
eval_steps = []
eval_losses = []

print("\n" + "="*50)
print(f"ğŸ“Š KURTARILAN EÄÄ°TÄ°M TABLOSU (DEEP)")
print("="*50)
print(f"{'AdÄ±m':<10} | {'Train Loss':<15} | {'Validation Loss':<20}")
print("-" * 50)

# Verileri ayrÄ±ÅŸtÄ±r ve tablo yap
for entry in log_history:
    if 'loss' in entry: # Train verisi
        step = entry['step']
        loss = entry['loss']
        train_steps.append(step)
        train_losses.append(loss)
        print(f"{step:<10} | {loss:<15.4f} | {'-':<20}")

    elif 'eval_loss' in entry: # Validation verisi
        step = entry['step']
        loss = entry['eval_loss']
        eval_steps.append(step)
        eval_losses.append(loss)
        # Tabloda eval satÄ±rÄ± genelde ayrÄ± basÄ±lÄ±r
        print(f"{step:<10} | {'-':<15} | {loss:<20.4f}")

# 4. BONUS: PDF Ä°Ã‡Ä°N GRAFÄ°K Ã‡Ä°Z (Bunu Raporuna KoyarsÄ±n!)
print("\n Grafik Ã§iziliyor...")

plt.figure(figsize=(10, 6))
plt.plot(train_steps, train_losses, label='Training Loss', color='blue', marker='o', markersize=3)
if eval_steps:
    plt.plot(eval_steps, eval_losses, label='Validation Loss', color='red', linewidth=2, marker='x')

plt.title('DEEP Model - EÄŸitim ve DoÄŸrulama HatasÄ± (Loss)')
plt.xlabel('AdÄ±m (Steps)')
plt.ylabel('Loss')
plt.legend()
plt.grid(True, linestyle='--', alpha=0.7)

# GrafiÄŸi kaydet
graph_path = "/content/deep_loss_graph.png"
plt.savefig(graph_path)
print(f" Grafik kaydedildi: {graph_path} (Bunu indirip rapora koy!)")
plt.show()
